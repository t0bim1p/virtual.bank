<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teardown Statue Casino 2025</title>
    <style>
        :root {
            --vbr-color: #ffcc00; --vbt-color: #00ccff;
            --common: #b0c3d9; --rare: #4b69ff; --mythical: #8847ff; --legendary: #d32ce6; --ancient: #eb4b4b;
            --bg: #121212; --card-bg: #1e1e1e;
            --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; overflow-x: hidden; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        nav { display: flex; background: #000; padding: 10px; position: sticky; top: 0; z-index: 100; border-bottom: 2px solid #333; }
        nav button { background: none; border: none; color: #aaa; padding: 10px 20px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        nav button.active { color: white; border-bottom: 2px solid var(--vbr-color); }
        .balance-bar { margin-left: auto; display: flex; gap: 20px; align-items: center; padding-right: 20px; }
        .user-info { display: flex; align-items: center; gap: 10px; }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page { display: none; padding: 20px; max-width: 1200px; margin: auto; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .statue-card {
            background: var(--card-bg); border-radius: 8px; padding: 15px; text-align: center;
            border-bottom: 4px solid var(--common); position: relative; transition: 0.2s; cursor: pointer;
        }
        .statue-card:hover { transform: translateY(-5px); background: #252525; }
        .icon { font-size: 50px; margin-bottom: 10px; display: block; }
        .price { font-weight: bold; color: var(--vbr-color); }
        .rarity-text { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* –ö–µ–π—Å—ã */
        .cases-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .case-preview { background: #2a2a2a; padding: 15px; border: 1px dashed #555; margin-bottom: 20px; display: flex; gap: 10px; overflow-x: auto; }

        /* –†—É–ª–µ—Ç–∫–∞ CS */
        .roulette-wrapper { width: 100%; height: 160px; position: relative; overflow: hidden; background: #000; border: 2px solid #333; margin: 20px 0; }
        .roulette-track { display: flex; position: absolute; left: 0; top: 0; transition: transform 5s cubic-bezier(0.1, 0, 0.1, 1); }
        .selector { position: absolute; left: 50%; top: 0; width: 4px; height: 100%; background: red; z-index: 5; transform: translateX(-50%); box-shadow: 0 0 10px red; }

        /* –ê–ø–≥—Ä–µ–π–¥–µ—Ä */
        .upgrader-container { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 30px; }
        .wheel-box { position: relative; width: 300px; height: 300px; }
        .wheel-svg { transform: rotate(-90deg); }
        .wheel-bg { fill: #333; }
        .wheel-chance { fill: transparent; stroke: #4CAF50; stroke-width: 32; stroke-dasharray: 0 100; transition: 0.5s; }
        .wheel-arrow { position: absolute; top: 0; left: 50%; width: 4px; height: 50%; background: #fff; transform-origin: bottom; transition: 4s cubic-bezier(0.15, 0, 0.15, 1); z-index: 10; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal { position: fixed; top:0; left:0; width: 100%; height:100%; background: rgba(0,0,0,0.9); z-index: 200; display:none; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 30px; border-radius: 10px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 90%; }
        
        /* –†–µ–¥–∫–æ—Å—Ç–∏ */
        .r-common { border-color: var(--common); } .r-rare { border-color: var(--rare); }
        .r-mythical { border-color: var(--mythical); } .r-legendary { border-color: var(--legendary); }
        .r-ancient { border-color: var(--ancient); box-shadow: 0 0 15px var(--ancient); }

        /* –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ */
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .leaderboard-table th { background: #333; padding: 12px; text-align: left; }
        .leaderboard-table td { padding: 12px; border-bottom: 1px solid #444; }
        .leaderboard-table tr:hover { background: #2a2a2a; }
        .medal-1 { color: var(--gold); font-weight: bold; }
        .medal-2 { color: var(--silver); font-weight: bold; }
        .medal-3 { color: var(--bronze); font-weight: bold; }

        /* –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-container { max-width: 400px; margin: 100px auto; background: #1e1e1e; padding: 40px; border-radius: 10px; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 5px; }
        .auth-btn { width: 100%; padding: 15px; background: var(--vbr-color); border: none; color: black; font-weight: bold; border-radius: 5px; cursor: pointer; }
        .auth-tabs { display: flex; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 10px; text-align: center; background: #333; cursor: pointer; }
        .auth-tab.active { background: var(--vbr-color); color: black; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
<div id="auth-screen">
    <div class="auth-container">
        <h2 style="text-align: center;">Teardown Statue Casino</h2>
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="showAuthTab('login')">–í—Ö–æ–¥</div>
            <div class="auth-tab" onclick="showAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>
        
        <div id="login-form">
            <input type="text" class="auth-input" id="login-name" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" class="auth-input" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-btn" onclick="login()">–í–æ–π—Ç–∏</button>
        </div>
        
        <div id="register-form" class="hidden">
            <input type="text" class="auth-input" id="register-name" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" class="auth-input" id="register-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="password" class="auth-input" id="register-pass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            <button class="auth-btn" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
        
        <p style="text-align: center; margin-top: 20px; color: #aaa;">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</p>
    </div>
</div>

<!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
<div id="main-interface" class="hidden">
    <nav>
        <div class="user-info">
            <span id="username-display">–ì–æ—Å—Ç—å</span>
            <button onclick="logout()" style="background: #555; padding: 5px 10px; font-size: 12px;">–í—ã–π—Ç–∏</button>
        </div>
        <button onclick="showPage('cases')" id="nav-cases">–ö–µ–π—Å—ã</button>
        <button onclick="showPage('inventory')" id="nav-inventory">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
        <button onclick="showPage('upgrader')" id="nav-upgrader">–ê–ø–≥—Ä–µ–π–¥–µ—Ä</button>
        <button onclick="showPage('exchange')" id="nav-exchange">–û–±–º–µ–Ω–Ω–∏–∫</button>
        <button onclick="showPage('leaderboard')" id="nav-leaderboard">–õ–∏–¥–µ—Ä—ã</button>
        <div class="balance-bar">
            <span title="–ö—É—Ä—Å: 1‚Ç± ‚âà 15 —Ä—É–±">–ë–∞–ª–∞–Ω—Å: <b id="bal-vbr">0</b> ‚Ç±</span>
            <span title="–ö—É—Ä—Å: 1‚Ç∏ ‚âà 35 —Ä—É–±"><b id="bal-vbt">0</b> ‚Ç∏</span>
        </div>
    </nav>

    <!-- –°–¢–†–ê–ù–ò–¶–ê –ö–ï–ô–°–û–í -->
    <div id="page-cases" class="page active">
        <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–µ–π—Å—ã</h2>
        <div class="cases-grid" id="cases-list"></div>
        
        <div id="opening-section" style="display:none; margin-top: 40px;">
            <h3 id="current-case-name">–û—Ç–∫—Ä—ã—Ç–∏–µ...</h3>
            <div class="roulette-wrapper">
                <div class="selector"></div>
                <div class="roulette-track" id="roulette-track"></div>
            </div>
            <button id="btn-open-action" style="padding: 15px 40px; font-size: 20px; background: #4CAF50; border: none; color: white; border-radius: 5px; cursor: pointer;">–ö–†–£–¢–ò–¢–¨</button>
        </div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê –ò–ù–í–ï–ù–¢–ê–†–Ø -->
    <div id="page-inventory" class="page">
        <h2>–ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
        <div class="cases-grid" id="inventory-list"></div>
        <div style="margin-top: 30px; padding: 20px; background: #1e1e1e; border-radius: 8px;">
            <h3>–°—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è: <span id="inventory-value">0</span> ‚Ç±</h3>
        </div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê –ê–ü–ì–†–ï–ô–î–ï–†–ê -->
    <div id="page-upgrader" class="page">
        <h2>–ê–ø–≥—Ä–µ–π–¥–µ—Ä –°—Ç–∞—Ç—É–π</h2>
        <div class="upgrader-container">
            <div class="statue-card" onclick="openPicker('my')" id="upg-source">
                <span class="icon">‚ûï</span><p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –ø—Ä–µ–¥–º–µ—Ç</p>
            </div>

            <div class="wheel-box">
                <svg class="wheel-svg" viewBox="0 0 32 32" width="100%" height="100%">
                    <circle class="wheel-bg" r="16" cx="16" cy="16"></circle>
                    <circle id="wheel-segment" class="wheel-chance" r="16" cx="16" cy="16" stroke-dasharray="0 100"></circle>
                </svg>
                <div class="wheel-arrow" id="upg-arrow"></div>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <span id="chance-text" style="font-size: 24px; font-weight: bold;">0%</span>
                </div>
            </div>

            <div class="statue-card" onclick="openPicker('target')" id="upg-target">
                <span class="icon">üéØ</span><p>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å</p>
            </div>
        </div>
        <div style="text-align: center; margin-top: 40px;">
            <button onclick="startUpgrade()" style="padding: 20px 60px; background: #e67e22; color: white; border: none; font-size: 24px; border-radius: 10px; cursor: pointer;">–ê–ü–ì–†–ï–ô–î</button>
        </div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê –û–ë–ú–ï–ù–ù–ò–ö–ê -->
    <div id="page-exchange" class="page">
        <h2>–û–±–º–µ–Ω –≤–∞–ª—é—Ç</h2>
        <div style="background: #222; padding: 20px; border-radius: 10px;">
            <p>–ö—É—Ä—Å: 1 ‚Ç∏ = 2.32 ‚Ç± (–Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö)</p>
            <input type="number" id="exch-amount" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Ç∏">
            <button onclick="exchangeVBTtoVBR()" style="background: var(--vbt-color); color: black;">–û–±–º–µ–Ω—è—Ç—å ‚Ç∏ –Ω–∞ ‚Ç±</button>
        </div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê –õ–ò–î–ï–†–ë–û–†–î–ê -->
    <div id="page-leaderboard" class="page">
        <h2>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
            <div>
                <h3>üèÜ –ü–æ –¥–µ–Ω—å–≥–∞–º (‚Ç± + ‚Ç∏)</h3>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th width="50">#</th>
                            <th>–ò–≥—Ä–æ–∫</th>
                            <th>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-money">
                        <tr><td colspan="3">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div>
                <h3>üì¶ –ü–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</h3>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th width="50">#</th>
                            <th>–ò–≥—Ä–æ–∫</th>
                            <th>–°—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-inventory">
                        <tr><td colspan="3">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div style="margin-top: 40px; background: #1e1e1e; padding: 20px; border-radius: 8px;">
            <h3>–í–∞—à–µ –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–∞—Ö:</h3>
            <p>‚Ä¢ –ü–æ –¥–µ–Ω—å–≥–∞–º: <span id="user-money-rank">-</span> –º–µ—Å—Ç–æ</p>
            <p>‚Ä¢ –ü–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—é: <span id="user-inventory-rank">-</span> –º–µ—Å—Ç–æ</p>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –í–´–ë–û–†–ê –ü–†–ï–î–ú–ï–¢–û–í -->
    <div id="picker-modal" class="modal">
        <div class="modal-content">
            <h2 id="picker-title">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</h2>
            <div class="cases-grid" id="picker-grid"></div>
            <button onclick="closePicker()" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<script>
/** –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• **/
const RARITIES = {
    common: { name: '–û–±—ã—á–Ω–æ–µ', color: '#b0c3d9' },
    rare: { name: '–†–µ–¥–∫–æ–µ', color: '#4b69ff' },
    mythical: { name: '–ú–∏—Ñ–∏—á–µ—Å–∫–æ–µ', color: '#8847ff' },
    legendary: { name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ', color: '#d32ce6' },
    ancient: { name: '–î—Ä–µ–≤–Ω–µ–µ', color: '#eb4b4b' }
};

const ITEMS = [
    { id: 's1', name: '–ö–∞–º–µ–Ω–Ω—ã–π –ö–æ—Ç', icon: 'üê±', price: 10, rarity: 'common' },
    { id: 's2', name: '–ú–µ–¥–Ω–∞—è –°–æ–±–∞–∫–∞', icon: 'üê∂', price: 25, rarity: 'common' },
    { id: 's3', name: '–ë—Ä–æ–Ω–∑–æ–≤–∞—è –°–≤–∏–Ω—å—è', icon: 'üê∑', price: 50, rarity: 'rare' },
    { id: 's4', name: '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π –í–æ–ª–∫', icon: 'üê∫', price: 150, rarity: 'rare' },
    { id: 's5', name: '–ó–æ–ª–æ—Ç–æ–π –õ–µ–≤', icon: 'ü¶Å', price: 450, rarity: 'mythical' },
    { id: 's6', name: '–ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π –î—Ä–∞–∫–æ–Ω', icon: 'üê≤', price: 1200, rarity: 'legendary' },
    { id: 'kotartur', name: '–ò–∑—É–º—Ä—É–¥–Ω–∞—è "–ö–û–¢–ê–†–¢–£–†"', icon: 'üêà', price: 5000, rarity: 'legendary' },
    { id: 'hopikai', name: '–ê–ª–º–∞–∑–Ω–∞—è "–•–û–ü–ò–ö–ê–ô–°"', icon: 'üíé', price: 15000, rarity: 'ancient' },
    { id: 'tobi', name: '–†—É–±–∏–Ω–æ–≤–∞—è "–¢–û–ë–ò"', icon: 'üêï', price: 50000, rarity: 'ancient' }
];

const CASES = [
    { id: 'c1', name: '–ó–≤–µ—Ä–∏–Ω—ã–π –ö–µ–π—Å', price: 100, items: ['s1', 's1', 's2', 's3', 's4'] },
    { id: 'c2', name: '–≠–ª–∏—Ç–Ω—ã–π –ö–µ–π—Å', price: 1500, items: ['s4', 's5', 's6', 'kotartur'] },
    { id: 'c3', name: '–ö–µ–π—Å –ë–æ–≥–æ–≤', price: 10000, items: ['s6', 'kotartur', 'hopikai', 'tobi'] }
];

/** –°–ò–°–¢–ï–ú–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô **/
const USERS_KEY = 'teardown_casino_users_v2';
const CURRENT_USER_KEY = 'teardown_current_user';

let currentUser = null;
let currentUpgSource = null;
let currentUpgTarget = null;
let isOpening = false;

/** –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò **/
function showAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-tab').forEach(t => {
        if (t.textContent === (tab === 'login' ? '–í—Ö–æ–¥' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è')) {
            t.classList.add('active');
        }
    });
    
    document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
    document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
}

function login() {
    const username = document.getElementById('login-name').value.trim();
    const password = document.getElementById('login-pass').value;
    
    if (!username || !password) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
        return;
    }
    
    const users = getUsers();
    const user = users.find(u => u.username === username && u.password === password);
    
    if (user) {
        currentUser = user;
        localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(user));
        showMainInterface();
        updateUI();
        alert(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`);
    } else {
        alert("–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å!");
    }
}

function register() {
    const username = document.getElementById('register-name').value.trim();
    const password = document.getElementById('register-pass').value;
    const password2 = document.getElementById('register-pass2').value;
    
    if (!username || !password) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
        return;
    }
    
    if (password !== password2) {
        alert("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!");
        return;
    }
    
    if (username.length < 3) {
        alert("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤!");
        return;
    }
    
    if (password.length < 4) {
        alert("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤!");
        return;
    }
    
    const users = getUsers();
    
    if (users.find(u => u.username === username)) {
        alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
        return;
    }
    
    const newUser = {
        username: username,
        password: password,
        vbr: 5000,
        vbt: 100,
        inventory: [],
        createdAt: new Date().toISOString()
    };
    
    users.push(newUser);
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
    
    currentUser = newUser;
    localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(newUser));
    showMainInterface();
    updateUI();
    alert(`–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`);
}

function logout() {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")) {
        currentUser = null;
        localStorage.removeItem(CURRENT_USER_KEY);
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('main-interface').classList.add('hidden');
        document.getElementById('login-name').value = '';
        document.getElementById('login-pass').value = '';
        showAuthTab('login');
    }
}

function getUsers() {
    const data = localStorage.getItem(USERS_KEY);
    return data ? JSON.parse(data) : [];
}

function saveCurrentUser() {
    if (!currentUser) return;
    
    const users = getUsers();
    const index = users.findIndex(u => u.username === currentUser.username);
    
    if (index !== -1) {
        users[index] = currentUser;
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
        localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
    }
}

function showMainInterface() {
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('main-interface').classList.remove('hidden');
}

/** –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê **/
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + pageId).classList.add('active');
    
    if (pageId === 'leaderboard') {
        renderLeaderboards();
    } else if (pageId === 'inventory') {
        renderInventory();
        updateInventoryValue();
    }
}

function updateUI() {
    if (!currentUser) return;
    
    document.getElementById('username-display').textContent = currentUser.username;
    updateBalances();
    renderCases();
    renderInventory();
    updateInventoryValue();
}

function updateBalances() {
    if (!currentUser) return;
    
    document.getElementById('bal-vbr').innerText = Math.floor(currentUser.vbr).toLocaleString();
    document.getElementById('bal-vbt').innerText = Math.floor(currentUser.vbt).toLocaleString();
}

/** –°–ò–°–¢–ï–ú–ê –ö–ï–ô–°–û–í **/
function renderCases() {
    const container = document.getElementById('cases-list');
    container.innerHTML = '';
    CASES.forEach(c => {
        const div = document.createElement('div');
        div.className = 'statue-card r-rare';
        div.innerHTML = `
            <span class="icon">üì¶</span>
            <b>${c.name}</b><br>
            <span class="price">${c.price} ‚Ç±</span>
            <div class="case-preview">
                ${c.items.map(id => `<span title="${ITEMS.find(i=>i.id===id).name}">${ITEMS.find(i=>i.id===id).icon}</span>`).join('')}
            </div>
            <button onclick="prepareOpening('${c.id}')">–û—Ç–∫—Ä—ã—Ç—å</button>
        `;
        container.appendChild(div);
    });
}

function prepareOpening(caseId) {
    if (!currentUser) return;
    
    const selectedCase = CASES.find(c => c.id === caseId);
    if(currentUser.vbr < selectedCase.price) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –í–ë–†!");
    
    document.getElementById('opening-section').style.display = 'block';
    document.getElementById('current-case-name').innerText = "–û—Ç–∫—Ä—ã—Ç–∏–µ: " + selectedCase.name;
    
    const track = document.getElementById('roulette-track');
    track.style.transition = 'none';
    track.style.transform = 'translateX(0)';
    track.innerHTML = '';

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 80 –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è –ª–µ–Ω—Ç—ã
    const tape = [];
    for(let i=0; i<80; i++) {
        const randId = selectedCase.items[Math.floor(Math.random() * selectedCase.items.length)];
        const item = ITEMS.find(it => it.id === randId);
        tape.push(item);
        
        const card = document.createElement('div');
        card.className = 'statue-card r-' + item.rarity;
        card.style.minWidth = '130px';
        card.style.margin = '0 5px';
        card.innerHTML = `<span class="icon">${item.icon}</span><small>${item.name}</small>`;
        track.appendChild(card);
    }

    document.getElementById('btn-open-action').onclick = () => {
        if(isOpening) return;
        isOpening = true;
        currentUser.vbr -= selectedCase.price;
        updateBalances();

        const itemWidth = 140; // 130 + 10 margin
        const winIndex = 75; // –í—ã–∏–≥—Ä—ã—à–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç
        const stopPos = (winIndex * itemWidth) - (document.querySelector('.roulette-wrapper').offsetWidth / 2) + (itemWidth / 2);
        const randomOffset = (Math.random() - 0.5) * 100;
        
        track.style.transition = 'transform 5s cubic-bezier(0.1, 0, 0.1, 1)';
        track.style.transform = `translateX(-${stopPos + randomOffset}px)`;

        setTimeout(() => {
            const winItem = tape[winIndex];
            alert(`–í–∞–º –≤—ã–ø–∞–ª–æ: ${winItem.name}!`);
            currentUser.inventory.push({...winItem, uid: Date.now()});
            isOpening = false;
            saveCurrentUser();
            renderInventory();
            updateInventoryValue();
        }, 5200);
    };
}

/** –ò–ù–í–ï–ù–¢–ê–†–¨ **/
function renderInventory() {
    const inv = document.getElementById('inventory-list');
    inv.innerHTML = '';
    
    if (!currentUser || !currentUser.inventory.length) {
        inv.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #777;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>';
        return;
    }
    
    currentUser.inventory.forEach(item => {
        const div = document.createElement('div');
        div.className = `statue-card r-${item.rarity}`;
        div.innerHTML = `<span class="icon">${item.icon}</span><b>${item.name}</b><br><span class="price">${item.price} ‚Ç±</span>`;
        inv.appendChild(div);
    });
}

function updateInventoryValue() {
    if (!currentUser) return;
    
    const totalValue = currentUser.inventory.reduce((sum, item) => sum + item.price, 0);
    document.getElementById('inventory-value').textContent = totalValue.toLocaleString();
}

/** –ê–ü–ì–†–ï–ô–î–ï–† **/
function openPicker(type) {
    if (!currentUser) return;
    
    const modal = document.getElementById('picker-modal');
    const grid = document.getElementById('picker-grid');
    modal.style.display = 'flex';
    grid.innerHTML = '';

    if(type === 'my') {
        if (!currentUser.inventory.length) {
            grid.innerHTML = '<div style="text-align: center; padding: 20px; color: #777;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>';
            return;
        }
        
        currentUser.inventory.forEach(item => {
            const d = document.createElement('div');
            d.className = `statue-card r-${item.rarity}`;
            d.innerHTML = `<span class="icon">${item.icon}</span><p>${item.name}</p>`;
            d.onclick = () => { currentUpgSource = item; updateUpgUI(); closePicker(); };
            grid.appendChild(d);
        });
    } else {
        ITEMS.forEach(item => {
            const d = document.createElement('div');
            d.className = `statue-card r-${item.rarity}`;
            d.innerHTML = `<span class="icon">${item.icon}</span><p>${item.name}</p><b class="price">${item.price} ‚Ç±</b>`;
            d.onclick = () => { currentUpgTarget = item; updateUpgUI(); closePicker(); };
            grid.appendChild(d);
        });
    }
}

function updateUpgUI() {
    if(currentUpgSource) {
        document.getElementById('upg-source').innerHTML = `<span class="icon">${currentUpgSource.icon}</span><p>${currentUpgSource.name}</p>`;
    }
    if(currentUpgTarget) {
        document.getElementById('upg-target').innerHTML = `<span class="icon">${currentUpgTarget.icon}</span><p>${currentUpgTarget.name}</p><b>${currentUpgTarget.price} ‚Ç±</b>`;
    }
    
    if(currentUpgSource && currentUpgTarget) {
        let chance = (currentUpgSource.price / currentUpgTarget.price) * 100;
        if(chance > 100) chance = 100;
        document.getElementById('chance-text').innerText = chance.toFixed(1) + "%";
        document.getElementById('wheel-segment').style.strokeDasharray = `${chance} 100`;
    }
}

function startUpgrade() {
    if(!currentUser) return;
    if(!currentUpgSource || !currentUpgTarget) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–∞ –ø—Ä–µ–¥–º–µ—Ç–∞!");
    
    // –ù–∞–π—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –ø–æ uid
    const sourceInInventory = currentUser.inventory.find(i => i.uid === currentUpgSource.uid);
    if (!sourceInInventory) {
        alert("–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ!");
        return;
    }
    
    if(sourceInInventory.price >= currentUpgTarget.price && sourceInInventory.id === currentUpgTarget.id) {
        return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –ø–æ–¥–æ—Ä–æ–∂–µ!");
    }

    const chance = (sourceInInventory.price / currentUpgTarget.price) * 100;
    const arrow = document.getElementById('upg-arrow');
    const fullSpins = 5 + Math.floor(Math.random() * 5);
    const randomDeg = Math.random() * 360;
    const totalDeg = (fullSpins * 360) + randomDeg;

    arrow.style.transform = `rotate(${totalDeg}deg)`;

    setTimeout(() => {
        const finalAngle = randomDeg;
        const winRange = (chance / 100) * 360;
        
        if(finalAngle <= winRange) {
            alert("–£–°–ü–ï–•! –í—ã –ø–æ–ª—É—á–∏–ª–∏ " + currentUpgTarget.name);
            currentUser.inventory.push({...currentUpgTarget, uid: Date.now()});
        } else {
            alert("–ù–ï–£–î–ê–ß–ê! –ü—Ä–µ–¥–º–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.");
        }
        
        currentUser.inventory = currentUser.inventory.filter(i => i.uid !== sourceInInventory.uid);
        currentUpgSource = null;
        updateUpgUI();
        updateBalances();
        updateInventoryValue();
        saveCurrentUser();
    }, 4100);
}

/** –û–ë–ú–ï–ù–ù–ò–ö **/
function exchangeVBTtoVBR() {
    if (!currentUser) return;
    
    const amt = parseFloat(document.getElementById('exch-amount').value);
    if(currentUser.vbt >= amt && amt > 0) {
        currentUser.vbt -= amt;
        currentUser.vbr += (amt * 2.32);
        updateBalances();
        saveCurrentUser();
        document.getElementById('exch-amount').value = '';
    } else {
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –í–ë–¢!");
    }
}

/** –õ–ò–î–ï–†–ë–û–†–î **/
function renderLeaderboards() {
    const users = getUsers();
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const moneyRanking = users.map(user => {
        const totalMoney = user.vbr + (user.vbt * 2.32); // –ü–µ—Ä–µ–≤–æ–¥–∏–º –í–ë–¢ –≤ –í–ë–†
        return {
            username: user.username,
            total: totalMoney,
            vbr: user.vbr,
            vbt: user.vbt
        };
    }).sort((a, b) => b.total - a.total);
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const inventoryRanking = users.map(user => {
        const inventoryValue = user.inventory.reduce((sum, item) => sum + item.price, 0);
        return {
            username: user.username,
            value: inventoryValue
        };
    }).sort((a, b) => b.value - a.value);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ –¥–µ–Ω—å–≥–∞–º
    const moneyTable = document.getElementById('leaderboard-money');
    moneyTable.innerHTML = '';
    
    moneyRanking.forEach((user, index) => {
        const tr = document.createElement('tr');
        let medalClass = '';
        if (index === 0) medalClass = 'medal-1';
        else if (index === 1) medalClass = 'medal-2';
        else if (index === 2) medalClass = 'medal-3';
        
        tr.innerHTML = `
            <td class="${medalClass}">${index + 1}</td>
            <td>${user.username}</td>
            <td><b>${Math.floor(user.total).toLocaleString()} ‚Ç±</b><br>
                <small>(${Math.floor(user.vbr).toLocaleString()} ‚Ç± + ${Math.floor(user.vbt).toLocaleString()} ‚Ç∏)</small>
            </td>
        `;
        moneyTable.appendChild(tr);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Å—Ç–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (currentUser && user.username === currentUser.username) {
            document.getElementById('user-money-rank').textContent = index + 1;
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—é
    const inventoryTable = document.getElementById('leaderboard-inventory');
    inventoryTable.innerHTML = '';
    
    inventoryRanking.forEach((user, index) => {
        const tr = document.createElement('tr');
        let medalClass = '';
        if (index === 0) medalClass = 'medal-1';
        else if (index === 1) medalClass = 'medal-2';
        else if (index === 2) medalClass = 'medal-3';
        
        tr.innerHTML = `
            <td class="${medalClass}">${index + 1}</td>
            <td>${user.username}</td>
            <td><b>${Math.floor(user.value).toLocaleString()} ‚Ç±</b></td>
        `;
        inventoryTable.appendChild(tr);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Å—Ç–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (currentUser && user.username === currentUser.username) {
            document.getElementById('user-inventory-rank').textContent = index + 1;
        }
    });
    
    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–π—Ç–∏–Ω–≥–∞—Ö
    if (currentUser && !moneyRanking.find(u => u.username === currentUser.username)) {
        document.getElementById('user-money-rank').textContent = '-';
        document.getElementById('user-inventory-rank').textContent = '-';
    }
}

/** –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò **/
function closePicker() { 
    document.getElementById('picker-modal').style.display = 'none'; 
}

/** –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø **/
function init() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const savedUser = localStorage.getItem(CURRENT_USER_KEY);
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ
            const users = getUsers();
            const userExists = users.find(u => u.username === currentUser.username && u.password === currentUser.password);
            
            if (userExists) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã
                currentUser = userExists;
                showMainInterface();
                updateUI();
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                localStorage.removeItem(CURRENT_USER_KEY);
                currentUser = null;
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", e);
            currentUser = null;
        }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    if (!currentUser) {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('main-interface').classList.add('hidden');
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.onload = init;
</script>
</body>
</html>
